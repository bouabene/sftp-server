var ChildProcess = require('child_process'),
    Util = require('util'),
    createParser = require('./parser');
eval(require('./constants'));

module.exports = proxy;

// Proxy to real sftp server and trace conversation
function proxy(req, res) {

  // Proxy to child process
  var child = ChildProcess.spawn("/usr/lib/openssh/sftp-server", ["-e"]);
  req.pipe(child.stdin);
  child.stdout.pipe(res);

  // TODO: find out how to do this in node 0.2.x and 0.4.x
  // child.stderr.pipe(process.stderr, { end: false });

  // Parse and Log the traffic from client
  createParser(req, function (type, args) {
    console.error("IN  " + FXP_LOOKUP[type] + " " + Util.inspect(args, false, 3));
  });
  req.on('data', function (chunk) {
    console.error("IN  " + chunk.inspect());
  });

  // Parse and Log response from child process
  createParser(child.stdout, function (type, args) {
    console.error("OUT " + FXP_LOOKUP[type] + " " + Util.inspect(args, false, 3));
  });
  child.stdout.on('data', function (chunk) {
    console.error("OUT " + chunk.inspect());
  });
}
